<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Absensi Pegawai</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Load Phosphor Icons for modern icons -->
    <script src="https://unpkg.com/@phosphor-icons/web@2.1.1"></script>
    
    <style>
        /* Konfigurasi Tailwind & Font */
        :root {
            --primary-blue: #1E40AF; /* Blue-800 */
            --light-blue: #3B82F6; /* Blue-500 */
            --dark-bg: #0F172A; /* Slate-900 */
            --card-bg: #1E293B; /* Slate-800 */
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--dark-bg);
            color: #E2E8F0; /* Slate-200 */
            transition: background-color 0.3s ease;
        }

        .card {
            background-color: var(--card-bg);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            border: 1px solid #334155; /* Slate-700 */
            transition: all 0.3s ease-in-out;
        }

        .btn-primary {
            background-color: var(--light-blue);
            color: white;
            transition: background-color 0.2s, transform 0.1s;
        }

        .btn-primary:hover {
            background-color: #2563EB; /* Blue-600 */
            transform: translateY(-1px);
        }
        
        /* Animasi Loading/Success Modal */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(5px);
            transition: opacity 0.3s ease;
        }
        
        .modal-content {
            transform: scale(0.9);
            opacity: 0;
            animation: bounceIn 0.3s ease-out forwards;
        }

        @keyframes bounceIn {
            0% { transform: scale(0.9); opacity: 0; }
            80% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Animasi Tombol Bergetar (Shake) untuk Error */
        .shake {
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
            20%, 40%, 60%, 80% { transform: translateX(10px); }
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Kontainer Utama Aplikasi -->
    <div id="app-container" class="w-full max-w-lg card rounded-xl p-6 md:p-10">
        <h1 class="text-3xl font-bold text-center mb-8 text-white flex items-center justify-center">
            <i class="ph-check-circle text-4xl mr-3 text-light-blue"></i>
            Sistem Absensi Digital
        </h1>

        <!-- Area Login -->
        <div id="login-screen">
            <p class="text-center mb-6 text-slate-400">Silakan masukkan Nomor Induk Pegawai (NIP) Anda untuk masuk.</p>
            <div class="space-y-4">
                <input type="text" id="nip-input" placeholder="Masukkan NIP Anda" class="w-full p-3 rounded-lg bg-slate-700 border border-slate-600 focus:ring-light-blue focus:border-light-blue text-white">
                <button id="login-btn" onclick="handleLogin()" class="btn-primary w-full p-3 rounded-lg font-semibold text-lg hover:shadow-lg hover:shadow-blue-500/50">
                    <i class="ph-sign-in-bold mr-2"></i> Masuk
                </button>
            </div>
            <p id="login-error" class="text-red-400 mt-4 text-center hidden"></p>
        </div>

        <!-- Area Dashboard Pegawai -->
        <div id="dashboard-screen" class="hidden">
            <!-- Biodata Pegawai -->
            <div id="user-info" class="mb-8 p-5 bg-slate-700 rounded-lg shadow-inner">
                <h2 class="text-xl font-semibold mb-2 text-white">Selamat Datang, <span id="user-name"></span>!</h2>
                <div class="text-sm text-slate-300 space-y-1">
                    <p><strong>NIP:</strong> <span id="user-nip"></span></p>
                    <p><strong>Departemen:</strong> <span id="user-dept"></span></p>
                    <p><strong>Level:</strong> <span id="user-level"></span></p>
                    <p class="text-xs text-slate-500 mt-2">ID Pengguna Internal: <span id="user-firestore-id"></span></p>
                </div>
            </div>

            <!-- Tombol Absen -->
            <div class="mb-8">
                <button id="absensi-btn" onclick="handleAttendance()" class="btn-primary w-full p-4 rounded-xl font-bold text-xl flex items-center justify-center transition-all duration-300">
                    <i class="ph-clock-countdown-bold text-2xl mr-2"></i>
                    <span>Absen Hari Ini</span>
                </button>
                <p id="absensi-status" class="text-center mt-3 font-medium"></p>
            </div>

            <!-- Riwayat Absensi -->
            <h3 class="text-xl font-semibold mb-4 text-white border-b border-slate-700 pb-2">Riwayat Absensi Anda</h3>
            <div id="attendance-history" class="h-64 overflow-y-auto pr-2 custom-scroll">
                <!-- Riwayat akan dimuat di sini -->
                <p class="text-center text-slate-400 italic">Memuat riwayat...</p>
            </div>

            <!-- Tombol Logout -->
            <button onclick="handleLogout()" class="mt-6 w-full text-slate-400 hover:text-red-400 transition-colors duration-200 text-sm">
                Keluar
            </button>
        </div>
    </div>

    <!-- Modal Loading dan Sukses (Hidden by default) -->
    <div id="status-modal" class="modal-overlay fixed inset-0 flex items-center justify-center z-50 opacity-0 hidden">
        <div id="modal-content" class="modal-content card rounded-xl p-8 max-w-sm text-center">
            <div id="modal-icon" class="text-5xl mb-4 text-light-blue">
                <i class="ph-spinner-gap-bold animate-spin"></i>
            </div>
            <p id="modal-text" class="text-xl font-semibold text-white">Sedang memproses absensi...</p>
        </div>
    </div>

    <!-- Load Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, where, orderBy, limit, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Global Variables (Canvas Environment) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'absensi-default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- Global Application State ---
        let db, auth;
        let userId = null;
        let employeeData = {}; // Data pegawai dari Google Sheet
        let loggedInUser = null;
        let isAuthReady = false;
        
        // --- Konfigurasi Lokasi Kantor ---
        // Kantor: S 6°13′29.809″ (6.22494694) E 106°48′52.269″ (106.81451914)
        const TARGET_LAT = -6.22494694;
        const TARGET_LON = 106.81451914;
        const MAX_DISTANCE_M = 200; // Maksimal 200 meter
        
        // --- Endpoint Google Sheet Data Pegawai (CSV) ---
        const EMPLOYEE_DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSv_eiU8hMGEFY4vYzMkh6unWqjgGx4JNJUQbunRDTavYxudywsuQiUnThtHoMyb7VtwK7kWTbQ2mfn/pub?gid=0&single=true&output=csv';
        
        // --- Endpoint Google Apps Script untuk Logging Absensi ---
        const GSCRIPT_LOG_URL = 'https://script.google.com/macros/s/AKfycby6cI35aYgKScfFD8ugnHb6IQjEj0wfoC45ES0BkXbLyKkTnEaLDHoj-lp0YXH9qhbB/exec';
        
        // --- DOM Elements ---
        const $loginScreen = document.getElementById('login-screen');
        const $dashboardScreen = document.getElementById('dashboard-screen');
        const $nipInput = document.getElementById('nip-input');
        const $loginError = document.getElementById('login-error');
        const $userName = document.getElementById('user-name');
        const $userNip = document.getElementById('user-nip');
        const $userDept = document.getElementById('user-dept');
        const $userLevel = document.getElementById('user-level');
        const $userFirestoreId = document.getElementById('user-firestore-id');
        const $absensiBtn = document.getElementById('absensi-btn');
        const $absensiStatus = document.getElementById('absensi-status');
        const $historyContainer = document.getElementById('attendance-history');
        const $statusModal = document.getElementById('status-modal');
        const $modalIcon = document.getElementById('modal-icon');
        const $modalText = document.getElementById('modal-text');
        
        // --- Utilities ---
        
        /**
         * Mengkonversi CSV string menjadi array of objects.
         * @param {string} csvText 
         * @returns {Object<string, Object>} Objek dengan NIP sebagai key
         */
        function csvToObjects(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim() !== '');
            if (lines.length === 0) return {};
            
            const headers = lines[0].split(',').map(h => h.trim().toUpperCase());
            const employees = {};
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                if (values.length !== headers.length) continue; 
                
                const NIP = values[headers.indexOf('NIP')];
                if (NIP) {
                    employees[NIP] = {
                        NIP: NIP,
                        NAMA: values[headers.indexOf('NAMA')] || 'Tidak Ada Data',
                        DEPARTMENT: values[headers.indexOf('DEPARTMENT')] || 'Tidak Ada Data',
                        LEVEL: values[headers.indexOf('LEVEL')] || 'Tidak Ada Data',
                    };
                }
            }
            return employees;
        }

        /**
         * Menghitung jarak antara dua koordinat (Haversine Formula) dalam meter.
         * @param {number} lat1 Latitude 1
         * @param {number} lon1 Longitude 1
         * @param {number} lat2 Latitude 2
         * @param {number} lon2 Longitude 2
         * @returns {number} Jarak dalam meter
         */
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Radius bumi dalam meter
            const φ1 = lat1 * Math.PI / 180; // φ, λ dalam radian
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c; // Jarak dalam meter
        }

        /**
         * Menampilkan modal status
         * @param {string} text Teks yang akan ditampilkan
         * @param {string} iconName Nama ikon (misal: 'ph-spinner-gap-bold', 'ph-check-circle-bold', 'ph-x-circle-bold')
         * @param {string} iconColor Warna ikon (misal: 'text-light-blue', 'text-green-500', 'text-red-500')
         * @param {boolean} showLoading true jika modal harus tetap tampil
         */
        function showModal(text, iconName, iconColor, showLoading = false) {
            $modalIcon.className = `text-5xl mb-4 ${iconColor}`;
            $modalIcon.innerHTML = `<i class="${iconName} ${iconName.includes('spinner') ? 'animate-spin' : ''}"></i>`;
            $modalText.textContent = text;
            $statusModal.classList.remove('hidden', 'opacity-0');
            $statusModal.classList.add('opacity-100');
            document.getElementById('modal-content').style.opacity = 1;
            document.getElementById('modal-content').style.transform = 'scale(1)';

            if (!showLoading) {
                setTimeout(() => {
                    $statusModal.classList.remove('opacity-100');
                    $statusModal.classList.add('opacity-0');
                    setTimeout(() => $statusModal.classList.add('hidden'), 300);
                }, 3000); // 3 detik
            }
        }

        function hideModal() {
            $statusModal.classList.remove('opacity-100');
            $statusModal.classList.add('opacity-0');
            setTimeout(() => $statusModal.classList.add('hidden'), 300);
        }

        /**
         * Menampilkan pesan error di form login
         */
        function displayLoginError(message) {
            $loginError.textContent = message;
            $loginError.classList.remove('hidden');
            $nipInput.classList.add('shake', 'border-red-500');
            setTimeout(() => {
                $nipInput.classList.remove('shake', 'border-red-500');
            }, 500);
        }

        function clearLoginError() {
            $loginError.classList.add('hidden');
            $loginError.textContent = '';
        }

        /**
         * Mengambil data pegawai dari Google Sheet (CSV)
         */
        async function loadEmployeeData() {
            try {
                const response = await fetch(EMPLOYEE_DATA_URL);
                const csvText = await response.text();
                employeeData = csvToObjects(csvText);
                console.log('Data Pegawai berhasil dimuat:', Object.keys(employeeData).length, 'pegawai');
                return true;
            } catch (error) {
                console.error('Gagal memuat data pegawai:', error);
                displayLoginError('Gagal memuat data pegawai. Cek koneksi Anda.');
                return false;
            }
        }
        
        /**
         * Transisi ke dashboard atau login screen
         */
        function updateScreen(isLoggedIn) {
            if (isLoggedIn) {
                $loginScreen.classList.add('hidden');
                $dashboardScreen.classList.remove('hidden');
                
                // Isi biodata pegawai
                $userName.textContent = loggedInUser.NAMA;
                $userNip.textContent = loggedInUser.NIP;
                $userDept.textContent = loggedInUser.DEPARTMENT;
                $userLevel.textContent = loggedInUser.LEVEL;
                $userFirestoreId.textContent = userId;
                
                // Mulai listener rekapan
                startAttendanceHistoryListener(loggedInUser.NIP);
                checkIfAbsentToday();

            } else {
                $loginScreen.classList.remove('hidden');
                $dashboardScreen.classList.add('hidden');
                $nipInput.value = '';
                loggedInUser = null;
                $absensiStatus.textContent = '';
                $absensiBtn.disabled = false;
                $absensiBtn.classList.remove('bg-gray-500', 'hover:bg-gray-500');
            }
        }

        // --- Firebase & Auth Initialization ---

        function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    isAuthReady = true;
                    if (user) {
                        userId = user.uid;
                        // Coba muat data pegawai (jika belum dimuat)
                        if (Object.keys(employeeData).length === 0) {
                            await loadEmployeeData();
                        }
                        
                        // Periksa apakah user memiliki sesi NIP yang tersimpan (Simulasi Persistent Login)
                        const storedNip = localStorage.getItem('absensi_nip');
                        if (storedNip && employeeData[storedNip]) {
                            loggedInUser = employeeData[storedNip];
                            updateScreen(true);
                            console.log("Otomatis login dengan NIP tersimpan:", storedNip);
                        } else {
                            updateScreen(false);
                        }
                    } else {
                        userId = null;
                        updateScreen(false);
                    }
                });

                if (initialAuthToken) {
                    signInWithCustomToken(auth, initialAuthToken)
                        .catch(err => {
                            console.error("Gagal sign in dengan custom token. Melakukan sign in anonim:", err);
                            signInAnonymously(auth);
                        });
                } else {
                    signInAnonymously(auth);
                }
            } catch (e) {
                console.error("Gagal inisialisasi Firebase:", e);
                displayLoginError("Kesalahan sistem: Gagal terhubung ke layanan data.");
            }
        }

        // --- Login & Logout Handlers ---

        window.handleLogin = async function() {
            clearLoginError();
            const nip = $nipInput.value.trim().toUpperCase();
            
            if (!nip) {
                displayLoginError('NIP tidak boleh kosong.');
                return;
            }

            if (Object.keys(employeeData).length === 0) {
                $loginError.textContent = 'Memuat data pegawai... tunggu sebentar.';
                await loadEmployeeData();
            }

            const user = employeeData[nip];
            
            if (user) {
                loggedInUser = user;
                localStorage.setItem('absensi_nip', nip);
                updateScreen(true);
            } else {
                displayLoginError('NIP tidak ditemukan. Pastikan NIP sudah benar.');
            }
        }

        window.handleLogout = async function() {
            localStorage.removeItem('absensi_nip');
            loggedInUser = null;
            await signOut(auth);
            updateScreen(false);
            $historyContainer.innerHTML = '<p class="text-center text-slate-400 italic">Riwayat telah dikosongkan.</p>';
        }


        // --- Firestore Attendance Logic ---

        /**
         * Mendapatkan path koleksi absensi untuk user saat ini.
         */
        function getAttendanceCollectionRef() {
            if (!db || !userId) throw new Error("Firebase atau User ID belum siap.");
            // Path: /artifacts/{appId}/users/{userId}/attendance_records
            return collection(db, 'artifacts', appId, 'users', userId, 'attendance_records');
        }

        /**
         * Memeriksa apakah pegawai sudah absen hari ini
         */
        async function checkIfAbsentToday() {
            if (!isAuthReady || !userId || !db) return;

            const today = new Date().toISOString().split('T')[0]; // Format YYYY-MM-DD
            
            $absensiStatus.className = 'text-center mt-3 font-medium text-slate-400';
            $absensiStatus.textContent = 'Memeriksa status absensi...';
            $absensiBtn.disabled = true;
            $absensiBtn.classList.add('bg-gray-500');

            try {
                const q = query(getAttendanceCollectionRef(), where('date', '==', today), limit(1));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    $absensiStatus.textContent = 'Anda sudah absen hari ini. Terima kasih!';
                    $absensiStatus.classList.replace('text-slate-400', 'text-green-400');
                    $absensiBtn.textContent = 'Sudah Absen';
                    $absensiBtn.disabled = true;
                } else {
                    $absensiStatus.textContent = 'Anda belum absen hari ini. Klik tombol di atas.';
                    $absensiStatus.classList.replace('text-slate-400', 'text-yellow-400');
                    $absensiBtn.innerHTML = '<i class="ph-clock-countdown-bold text-2xl mr-2"></i><span>Absen Hari Ini</span>';
                    $absensiBtn.disabled = false;
                    $absensiBtn.classList.remove('bg-gray-500', 'hover:bg-gray-500');
                }
            } catch (error) {
                console.error("Gagal memeriksa status absensi:", error);
                $absensiStatus.textContent = 'Gagal memuat status absensi.';
                $absensiStatus.classList.replace('text-slate-400', 'text-red-400');
                $absensiBtn.disabled = false;
                $absensiBtn.classList.remove('bg-gray-500', 'hover:bg-gray-500');
            }
        }

        /**
         * Memulai listener untuk riwayat absensi
         * @param {string} nip pegawai
         */
        function startAttendanceHistoryListener(nip) {
            if (!isAuthReady || !userId || !db) return;
            
            // Query 10 riwayat terakhir
            // Catatan: Karena ada masalah indexing di Canvas, kita ambil data lalu sorting secara manual
            // const q = query(getAttendanceCollectionRef(), orderBy('timestamp', 'desc'), limit(10));
            
            const q = query(getAttendanceCollectionRef(), limit(100)); // Ambil lebih banyak untuk sorting lokal

            onSnapshot(q, (snapshot) => {
                let records = [];
                snapshot.forEach((doc) => {
                    records.push(doc.data());
                });

                // Sortir data secara manual di JavaScript (descending timestamp)
                records.sort((a, b) => b.timestamp - a.timestamp);
                
                // Batasi hanya 10 data teratas setelah sorting
                records = records.slice(0, 10);

                let html = '';
                if (records.length === 0) {
                    html = '<p class="text-center text-slate-400 italic">Belum ada riwayat absensi.</p>';
                } else {
                    records.forEach((data) => {
                        const time = new Date(data.timestamp).toLocaleString('id-ID', {
                            dateStyle: 'long', 
                            timeStyle: 'short'
                        });
                        const statusColor = data.inProximity ? 'text-green-400' : 'text-red-400';
                        const locationStatus = data.inProximity ? 
                            `<span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-green-900/50 ${statusColor}">Di Lokasi Kantor</span>` : 
                            `<span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-red-900/50 ${statusColor}">Di Luar Lokasi</span>`;

                        html += `
                            <div class="p-3 mb-2 bg-slate-800 rounded-lg flex justify-between items-center transition-transform duration-200 hover:scale-[1.01]">
                                <div>
                                    <p class="font-semibold text-white">${time}</p>
                                    <p class="text-xs text-slate-400">Lat: ${data.lat.toFixed(5)}, Lon: ${data.lon.toFixed(5)}</p>
                                </div>
                                ${locationStatus}
                            </div>
                        `;
                    });
                }
                $historyContainer.innerHTML = html;
            }, (error) => {
                console.error("Kesalahan listener riwayat absensi:", error);
                $historyContainer.innerHTML = '<p class="text-center text-red-400 italic">Gagal memuat riwayat.</p>';
            });
        }

        // --- Attendance Handler ---

        window.handleAttendance = async function() {
            if (!loggedInUser || !userId || !db) {
                console.error("User not logged in or Firebase not ready.");
                return;
            }
            
            // Status Awal
            showModal('Sedang memproses absensi...', 'ph-spinner-gap-bold', 'text-light-blue', true);
            $absensiBtn.disabled = true;

            try {
                // 1. Cek Ulang Status Absen Hari Ini
                const today = new Date().toISOString().split('T')[0];
                const q = query(getAttendanceCollectionRef(), where('date', '==', today), limit(1));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    showModal('Anda sudah absen hari ini. Absensi dibatalkan.', 'ph-info-bold', 'text-yellow-400');
                    await checkIfAbsentToday(); // Update status UI
                    return;
                }

                // 2. Get Geolocation
                showModal('Mendapatkan lokasi Anda...', 'ph-map-pin-line-bold', 'text-light-blue', true);
                
                const position = await new Promise((resolve, reject) => {
                    if (!navigator.geolocation) {
                        return reject(new Error("Geolocation tidak didukung di browser Anda."));
                    }
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true, 
                        timeout: 10000, 
                        maximumAge: 0
                    });
                });

                const userLat = position.coords.latitude;
                const userLon = position.coords.longitude;
                const distance = getDistance(userLat, userLon, TARGET_LAT, TARGET_LON);
                const inProximity = distance <= MAX_DISTANCE_M;
                const timestamp = new Date().getTime();

                // 3. Prepare Data
                const attendanceRecord = {
                    nip: loggedInUser.NIP,
                    name: loggedInUser.NAMA,
                    department: loggedInUser.DEPARTMENT,
                    level: loggedInUser.LEVEL,
                    lat: userLat,
                    lon: userLon,
                    distance: parseFloat(distance.toFixed(2)),
                    inProximity: inProximity,
                    timestamp: timestamp,
                    date: today, // Untuk query harian
                    firestoreUserId: userId,
                };
                
                // 4. Submit ke Google Apps Script
                showModal('Mengirim data ke server...', 'ph-cloud-arrow-up-bold', 'text-light-blue', true);

                const params = new URLSearchParams(attendanceRecord).toString();
                const gScriptUrlWithParams = `${GSCRIPT_LOG_URL}?${params}`;

                // Kirim data ke Google Sheet (Apps Script)
                const gScriptResponse = await fetch(gScriptUrlWithParams, { method: 'GET', mode: 'no-cors' });
                // Note: Karena menggunakan 'no-cors', kita tidak bisa membaca respons, 
                // hanya memastikan fetch berjalan tanpa error.

                // 5. Simpan ke Firestore (untuk dashboard dan cek harian)
                // Menggunakan addDoc untuk membuat ID unik
                await addDoc(getAttendanceCollectionRef(), attendanceRecord);

                // 6. Success
                const message = inProximity ? 
                    `Terima kasih sudah absen hari ini! Jarak Anda: ${distance.toFixed(2)}m.` : 
                    `Absensi tercatat, namun Anda berada di luar area kantor (Jarak: ${distance.toFixed(2)}m).`;
                
                showModal(message, inProximity ? 'ph-check-circle-bold' : 'ph-warning-bold', inProximity ? 'text-green-500' : 'text-red-500');

            } catch (error) {
                // PERBAIKAN: Menggunakan stringify dengan properti agar output console tidak ganda ({})
                const errorDetails = JSON.stringify(error, Object.getOwnPropertyNames(error)) || error.toString();
                console.error("Kesalahan proses absensi (detail): " + errorDetails);
                
                let errorMessage = 'Terjadi kesalahan tidak terduga saat absen.';
                
                // Gunakan pesan error yang aman, default ke string jika tidak ada properti message
                const errorString = error.message || (error.toString().includes('[object') ? 'Kesalahan Geolocation/API.' : error.toString());
                
                if (error.code === 1 || errorString.toLowerCase().includes('permission')) {
                    errorMessage = 'Akses Geolocation ditolak. Harap izinkan lokasi untuk absen.';
                } else if (errorString.toLowerCase().includes('timeout')) {
                    errorMessage = 'Gagal mendapatkan lokasi: Waktu habis.';
                } else {
                    // Jika errorString masih generic, berikan pesan yang lebih deskriptif
                    if (errorString.includes('object')) {
                        errorMessage = 'Gagal mendapatkan lokasi. Pastikan koneksi dan izin lokasi sudah aktif.';
                    } else {
                        errorMessage = `Gagal: ${errorString}`;
                    }
                }
                
                showModal(errorMessage, 'ph-x-circle-bold', 'text-red-500');

            } finally {
                // Selalu panggil setelah 3 detik berlalu atau setelah error muncul
                setTimeout(() => {
                    checkIfAbsentToday(); // Pengecekan ulang status dan mengaktifkan/menonaktifkan tombol
                }, 3000);
            }
        }


        // --- Startup ---
        window.onload = async () => {
            await loadEmployeeData(); // Muat data pegawai saat startup
            initFirebase();           // Inisialisasi Firebase
        };

    </script>
</body>
</html>
